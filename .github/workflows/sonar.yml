name: SonarQube Analysis Comment

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  sonarqube:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: SonarQube Quality Gate
        id: sonarqube-quality-gate
        continue-on-error: true
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: Get SonarQube Results
        id: sonar-results
        if: always()
        run: |
          sleep 10  # SonarQube ë¶„ì„ ê²°ê³¼ê°€ ë°˜ì˜ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          
          QUALITY_GATE=$(curl -X GET -H "Authorization: Bearer ${{ secrets.SONAR_TOKEN }}" \
            "${{ secrets.SONAR_HOST_URL }}/api/qualitygates/project_status?projectKey=team4_fe" \
            | jq -r '.projectStatus.status')
          echo "QUALITY_GATE=${QUALITY_GATE}" >> $GITHUB_ENV
          
          NEW_ISSUES=$(curl -X GET -H "Authorization: Bearer ${{ secrets.SONAR_TOKEN }}" \
            "${{ secrets.SONAR_HOST_URL }}/api/issues/search?componentKeys=team4_fe&createdAfter=$(date -d '24 hours ago' --iso-8601=seconds)&types=BUG,VULNERABILITY,CODE_SMELL" \
            | jq -r '.total')
          echo "NEW_ISSUES=${NEW_ISSUES}" >> $GITHUB_ENV

      - name: Comment PR
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const qualityGateStatus = process.env.SONAR_QUALITY_GATE_STATUS || 'ì‹¤í–‰ ì‹¤íŒ¨';
            const newIssues = process.env.NEW_ISSUES || 'í™•ì¸ ë¶ˆê°€';
            
            let statusEmoji;
            if (qualityGateStatus === 'PASSED') {
              statusEmoji = 'âœ…';
            } else if (qualityGateStatus === 'FAILED') {
              statusEmoji = 'âŒ';
            } else {
              statusEmoji = 'âš ï¸';
            }
            
            const comment = `### SonarQube ë¶„ì„ ê²°ê³¼
            
            ${statusEmoji} **Quality Gate**: ${qualityGateStatus}
            ğŸ“Š **ìƒˆë¡œ ë°œìƒí•œ ì´ìŠˆ**: ${newIssues} ê°œ 
            [ìì„¸í•œ ë¶„ì„ ê²°ê³¼ ë³´ê¸°] https://ai.nowon.store/dashboard?id=team4_fe 
            
            ì½”ë“œ í’ˆì§ˆí–¥ìƒì„ ìœ„í•´ í•„ìˆ˜ê°€ ì•„ë‹Œ ê¶Œì¥ì‚¬í•­ì´ë©°, ì´ìŠˆë¥¼ í•´ê²°í•˜ì§€ ì•Šì•„ë„ ë¬´ë°©í•©ë‹ˆë‹¤.
            `;
            
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
