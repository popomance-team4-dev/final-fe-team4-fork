name: SonarQube Analysis Comment

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  sonarqube:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: SonarQube Quality Gate
        id: sonarqube-quality-gate
        continue-on-error: true
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: Get SonarQube Analysis Results
        id: sonar-results
        run: |
          QUALITY_GATE=$(curl --silent -H "Authorization: Bearer ${{ secrets.SONAR_TOKEN }}" "${{ secrets.SONAR_HOST_URL }}api/qualitygates/project_status?projectKey=team4_fe" | jq -r '.projectStatus.status')
          echo "QUALITY_GATE=$QUALITY_GATE" >> $GITHUB_OUTPUT
          
          ISSUES=$(curl --silent -H "Authorization: Bearer ${{ secrets.SONAR_TOKEN }}" "${{ secrets.SONAR_HOST_URL }}api/issues/search?componentKeys=team4_fe&resolved=false" | jq -r '.total')
          echo "NEW_ISSUES=$ISSUES" >> $GITHUB_OUTPUT


      - name: Comment PR
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const qualityGateStatus = "${{ steps.sonar-results.outputs.QUALITY_GATE }}";
            const newIssues = "${{ steps.sonar-results.outputs.NEW_ISSUES }}";
            const issues = JSON.parse("${{ steps.sonar-results.outputs.ISSUES }}");
            
            let statusEmoji;
            if (qualityGateStatus === 'OK') {
              statusEmoji = 'âœ…';
            } else {
              statusEmoji = 'âŒ';
            }

            let issueList = '';
            if (issues.length > 0) {
              issueList = '### ì£¼ìš” ì´ìŠˆ ëª©ë¡:\n';
              for (const issue of issues) {
                issueList += `- **${issue.type}** (${issue.severity}) - íŒŒì¼: ${issue.line}, ë©”ì‹œì§€: ${issue.message}\n`;
              }
            }
            
            const comment = `## SonarQube ë¶„ì„ ê²°ê³¼
            > ì½”ë“œ í’ˆì§ˆí–¥ìƒì„ ìœ„í•´ í•„ìˆ˜ê°€ ì•„ë‹Œ ê¶Œì¥ì‚¬í•­ì´ë©°, ì´ìŠˆë¥¼ í•´ê²°í•˜ì§€ ì•Šì•„ë„ ë¬´ë°©í•©ë‹ˆë‹¤. 
            
            ${statusEmoji} Quality Gate : **${qualityGateStatus}**

            ğŸ“Š ì½”ë“œ í’ˆì§ˆ ì´ìŠˆ : **${newIssues}** ê°œ   [ì´ìŠˆ í™•ì¸](${{ secrets.SONAR_HOST_URL }}dashboard?id=team4_fe) 
            ${issueList}

            `;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
